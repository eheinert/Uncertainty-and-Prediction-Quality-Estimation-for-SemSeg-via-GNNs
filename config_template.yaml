#### Explanation ###################################################################################
# For custom use, you should include further dataset classes in "dataset specific settings" and/or 
# semseg models in "semantic segmentation settings", then modify the general "MetaSeg settings"
# according to this. For instructions on how to set up dataset and semseg classes, see README.md 
####################################################################################################



####################################################################################################
#### MetaSeg settings ##############################################################################
####################################################################################################
# dataset: name of dataset, key in 'data specific settings'
# semseg_model: name of semseg architecture, key in 'semantic segmentation settings' 
# meta_target: choose from {iou, iou0}
# meta_model: type of MetaSeg model, choose from {logistic, gradient_boosting_classifier} for iou0
#                                            and {linear, gradient_boosting_regressor} for iou
# val_multiparam: 0 : no validation,     
#                 0 < val_multiparam < 1 : portion of meta_train data used for training
#                 =1 : assumes explicit meta_val set in cfg[dataset].splits (i.e. dataset settings)
#                 >= 2 : Kfold cross validation, then fitting on complete meta_train data
# infer_blend: choose from [0,1] with 0 = solely prediction, 1 solely original image
# metaseg_data: path to meta metrics (computed from softmax probabilities generated by semseg model)
# plots: path to graphic representations of IoU predictions, i.e. meta inference
# meta_model: directory to save meta model in 
####################################################################################################

dataset: data_template
semseg_model: semseg_template
meta_model: linear
meta_target: iou
val_multiparam: 5
seed: 42
infer_blend: 0.6
save_roots:
  metaseg_data: path/to/meta_metrics/
  meta_inference: path/to/inference/
  meta_model: path/to/meta_models/

#################################################################################################
#### dataset specific settings / collection of dataset cfgs #####################################
#################################################################################################
# _target_: path to dataset class
# Furthermore all the parameters needed to set up the dataloader, for cityscapes:
#   probs_root: path to softmax preds of semseg model, base for computation of meta metrics
#   target_root: path to semseg ground truth, used to compute meta labels
#   images_root: path to input data of non meta model
#   mode: always one of the splits, used to set cfg to either training or inference mode.
#   splits: subfolders used for training/inference purposes.
#################################################################################################

data_template:
  _target_: metaseg.datasets.cityscapes.Template # dataloader class
  probs_root: path/to/softmax_probs/    # needs to exist for meta_data computation
  # plus further parameters that you need to set up your dataloader
  mode: meta_train
  splits: 
    meta_train: meta_train_split #needs ground truths
    meta_inference: meta_infer_split #does not need ground truths
  # it is your choice how to handle those in the data set class, however one should be able to 
  # change the mode via cfg[dataset_name].mode = mode for any mode in {meta_train, meta_inference}.
  

cityscapes: #examplary dataset
  _target_: metaseg.datasets.cityscapes.Cityscapes
  images_root: DV3+_WRN38_on_cityscapes/cityscapes/leftImg8bit
  target_root: DV3+_WRN38_on_cityscapes/cityscapes/gtFine
  probs_root: DV3+_WRN38_on_cityscapes/cityscapes/softmax_probs
  mode: meta_train
  splits:
    meta_train: val
    meta_infer: test


#################################################################################################
#### semantic segmentation settings / collection of semseg cfgs #################################
#################################################################################################
# checkpoint: path to semseg checkpoint/weights
# model._target_: path to your model class
# loader: path to function that initializes the segmentation network
# Furthermore all parameters needed to initalize the specific semseg model:
#################################################################################################

semseg_template: # model template
  checkpoint: path/to/checkpoint.pth
  loader: path.to.loader_func
  model:
    _target_: path.to.ModelClass
    # add further parameters for loading your semseg model, e.g. num_classes

DeepLabWV3+: # examplary semseg model
  checkpoint: DV3+_WRN38_on_cityscapes/DeepLabV3+_WideResNet38_cityscapes.pth
  loader: semseg_models.model_loaders.init_deeplabwv3_plus
  model:
    _target_: semseg.models.deepv3.DeepWV3Plus
    num_classes: 19







##################################################################################################
### Everything below this line should not neccessarily be changed. However, you are welcome to 
### implement additional meta_models or change the parallelization settings.
##################################################################################################








#################################################################################################
#### meta model specific settings / collection of implemented meta models #######################
#################################################################################################
# implementations in metaseg/models.py, for further details see sklearn documentations. #########
#################################################################################################

logistic:
  _target_: metaseg.models.logistic_regressor
  random_state: 0
  solver: saga
  max_iter: 1000
  tol: 1e-3

linear:
  _target_: metaseg.models.linear_regressor

gradient_boosting_classifier:
  _target_: metaseg.models.gradient_boosting_classfier
  random_state: 0
  n_estimators: 100
  min_samples_split: 2
  min_samples_leaf: 1
  max_depth: 3

gradient_boosting_regressor:
  _target_: metaseg.models.gradient_boosting_regressor
  random_state: 0
  n_estimators: 100
  min_samples_split: 2
  min_samples_leaf: 1
  max_depth: 3


##################################################################################################
#### multiprocessing #############################################################################
##################################################################################################

worker:
  parallel: True
  num_cpus: 5
  chunksize: 1


##################################################################################################
#### hydra settings                                       ########################################
#### uncomment all the following to fully disable logging ########################################
##################################################################################################

defaults:
  - _self_
  - override hydra/hydra_logging: disabled
  - override hydra/job_logging: disabled
hydra:
  output_subdir: null
  run:
    dir: .